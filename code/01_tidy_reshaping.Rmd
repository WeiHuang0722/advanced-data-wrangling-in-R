---
title: 'Tidy Data and Reshaping'
author: "Jae Yeon Kim"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

This workshop is for students who already have some experience with `tidyr` and `dplyr` and `tidyr` and hope to upgrade their data wrangling skills in R.

# Setup

- `pacman` is a great package management tool in R (for more information, see [the package vignette](http://trinker.github.io/pacman/vignettes/Introduction_to_pacman.html)).

- Check your `dplyr` package is up-to-date by typing `packageVersion("dplyr")`. If the current installed version is less than 1.0, then update by typing `update.packages("dplyr")`. You may need to restart R to make it work.

```{r}

ifelse(packageVersion("dplyr") > 1, "The installed version of dplyr package is greater than or equal to 1.0.0", update.packages("dplyr"))

```


```{r include = FALSE}

# p_load loads and, if necessary, install missing packages.
# install.packages() + library() = p_load()
# If you just want to install, then use p_install()

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  tidyverse, # for the tidyverse framework
  here # for computational reproducibility
  )

```

# (Optional) Project-oriented workflow

Read Jenny Bryan's great article on [project-oriented workflow](https://www.tidyverse.org/blog/2017/12/workflow-vs-script/). The key idea is [computatinoal reproduciblity](http://web.stanford.edu/~vcs/talks/Utah2018-STODDEN.pdf). To ensure that, we need to make a project self-contained.

- Note that `setwd()` is not reproducible outside the author's local machine. Instead, learn to use `here()`'.

- Do not save .RData when you quit R and don't load. Using [Bash](https://www.gnu.org/software/bash/), add the following line in `.bash_profile`: `alias R='R --no-save --no-restore-data'` (More information on [invoking R](https://colinfay.me/intro-to-r/appendix-b-invoking-r.html) by W. N. Venables and D. M. Smith (R Core Team))

# (Required) Project organization

Read [Software Carpentry](https://software-carpentry.org/lessons/index.html)'s article on [project management in RStudio](https://swcarpentry.github.io/r-novice-gapminder/02-project-intro/).

*Tips for file organization*

- See ["Good Enough Practices in Scientific Computing"](https://github.com/swcarpentry/good-enough-practices-in-scientific-computing/blob/gh-pages/good-enough-practices-for-scientific-computing.pdf) by [PLOS](https://plos.org/)

- You can create directories on your computer from R using `dir.create` function.

0. Create a project directory 

```{r}
# Create a project directory 
# .. subdirectory 
# I assume that your current working directory is advanced-data-wrangling-in-R. Check this by running `getwd()`

dir.create("../project")

```

1. Treat raw data as read only (raw data should be RAW!)

```{r}
dir.create(here::here("project", "data"))
```

2. Separate read-only data from processed data

```{r}
dir.create(here::here("project", "processed_data"))
```

3. Treat generated outputs as disposable

```{r}
dir.create(here::here("project", "outputs"))
```

4. Separate function definition and application

```{r}
dir.create(here::here("project", "functions"))
```

5. Version control [using Git from RStudio](https://swcarpentry.github.io/git-novice/14-supplemental-rstudio/)

The rest of the workshop follows the basic structure in [the Data Wrangling Cheat Sheet](https://rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf) created by RStudio.

# Tidy Data

Many of the following examples draw on [R for Data Science](https://r4ds.had.co.nz/) by Garrett Grolemund and Hadley Wickham.

> "Tidy data sets are easy to manipulate, model and visualize, and have a specific structure: each variable is a column, each observation is a row, and each type of observational unit is a table." - Hadley Wickham

1. Variables -> **Columns**
2. Observations -> **Rows**
3. Values -> **Cells**

![Tidy Data Example (Source: R for Data Science)](https://garrettgman.github.io/images/tidy-1.png)

A tidy data can be stored in a `data.frame` or [`tibble`](https://tibble.tidyverse.org/) object.

**Benefits**

> "If your data is tidy, element-wise execution will ensure that observations are preserved across functions and operations. Each value will only be paired with other values that appear in the same row of the data frame." 
- Garrett Grolemund and Hadley Wickham

- Nevertheless, don't be religious.

> In summary, tidy data is a useful conceptual idea and is often the right way to go for general, small data sets, but may not be appropriate for all problems. - Jeff Leek

For instance, in many data science applications, linear algebra-based computations are essential (e.g., [Principal Component Analysis](https://www.math.upenn.edu/~kazdan/312S13/JJ/PCA-JJ.pdf)). These computations are optimized to work on matrices, not tidy data frames (for more information, read [Jeff Leek's blog post](https://simplystatistics.org/2016/02/17/non-tidy-data/)).

This is what a tidy data looks like.

```{r}

library(tidyverse)

table1

```

**Additional tips**

Packages for importing data:

1. Basic: `readr`
2. SPSS, Stata, and SAS files: `haven`
3. Database: `DBI`
4. json: `jsonlite`
5. Web APIs: `httr`
6. HTML: `rvest`

# Reshape Data

Let's take a look at the cases of untidy data.

![Messy Data Case 1 (Source: R for Data Science)](https://garrettgman.github.io/images/tidy-5.png)

## Make It Longer

- Challenge 1: What's the problem with the data?

```{r}

table4a

```

- Let's pivot (rotate by 90 degree).

- [`pivot_longer()`](https://tidyr.tidyverse.org/reference/pivot_longer.html) increases the number of rows (longer) and decreases the number of columns. The inverse function is `pivot_wider()`. These functions improve the usability of `gather()` and `spread()`.

![What pivot_longer() does (Source: https://www.storybench.org)](https://www.storybench.org/wp-content/uploads/2019/08/pivot-longer-image.png)

```{r}

# Old way, less intuitive
table4a %>%
  gather(key = "cases", # Current column names
         value = "year", # The values matched to cases
         c("1999", "2000")) # Selected columns

```

```{r}

# New way, more intuitive
table4a %>%
  pivot_longer(
    cols = c("1999", "2000"), # Selected columns
    names_to = "year", # Shorter columns (the columns going to be in one column called year)
    values_to = "cases") # Longer rows (the values are going to be in a separate column called named cases)

```

- There's another problem, did you catch it?

- The data type of `year` variable should be `numeric` not `character`. By default, `pivot_longer()` transforms uninformative columns to character.

- You can fix this problem by using `names_transform` argument.

```{r}

table4a %>%
  pivot_longer(
    cols = c("1999", "2000"), # Put two columns together
    names_to = "year", # Shorter columns (the columns going to be in one column called year)
    values_to = "cases", # Longer rows (the values are going to be in a separate column called named cases)
    names_transform = list(year = readr::parse_number)
    ) # Transform the variable  

```

**Additional tips**

`parse_number()` also keeps only numeric information in a variable.

```{r}

parse_number("reply1994")

```

A flat file (e.g., CSV) is a rectangular shaped combination of strings. [Parsing](https://cran.r-project.org/web/packages/readr/vignettes/readr.html) determines the type of each column and turns into a vector of a more specific type. Tidyverse has `parse_` functions (from `readr` package) that are flexible and fast (e.g., `parse_integer()`, `parse_double()`, `parse_logical()`, `parse_datetime()`, `parse_date()`, `parse_time()`, `parse_factor()`, etc).

**Practice 1**

- Let's do another practice. 

1. What's the main problem with this data? (This exercise comes from [`pivot` function vigenette](https://tidyr.tidyverse.org/articles/pivot.html).) Too long or too wide?

```{r}

billboard

```

2. How can you fix it? Which pivot?

```{r}

# Old way
billboard %>%
  gather(key = "week",
         value = "rank",
         starts_with("wk")) %>% # Use regular expressions
  drop_na() # Drop NAs

```

- Note that `pivot_longer()` is more versatile than `gather()`.

```{r}

# New way
billboard %>%
  pivot_longer(
    cols = starts_with("wk"), # Use regular expressions
    names_to = "week",
    values_to = "rank",
    values_drop_na = TRUE # Drop NAs
  )

```

## Make It Wider

- What's the problem with the data?

```{r}
table2
```

- Each observation is spread across two rows.

- How can you fix it?: `pivot_wider()`.

**Two differences between `pivot_longer()` and `pivot_wider()`**

- In `pivot_longer()`, the arguments are named `names_to` and `values_to` (*to*). 

- In `pivot_wider()`, this pattern is opposite. The arguments are named `names_from` and `values_from` (*from*).

- The number of required arguments for `pivot_longer()` is 3 (col, names_to, values_to). 

- The number of required arguments for `pivot_wider()` is 2 (names_from, values_from).

![What pivot_wider() does (Source: https://www.storybench.org)](https://www.storybench.org/wp-content/uploads/2019/08/pivot-wider-image.png)

```{r}

# Old way
table2 %>%
  spread(key = type,
         value = count)

```

```{r}
# New way
table2 %>%
  pivot_wider(
    names_from = type, # first
    values_from = count # second
  )

```

**Practice 2**

Sometimes, a consultee came to me and asked: "I don't have missing values in my original dataframe. Then R said that I have missing values after I've done some data transformations. What happened?" 

Here's an answer. 

R defines missing values in two ways.

- *Implicit missing values*: simply not present in the data.

- *Explicit missing values*: flagged with NA

**Practice 2**

The example comes from [*R for Data Science*](https://r4ds.had.co.nz/tidy-data.html).

```{r}

stocks <- tibble(
  year = c(2019, 2019, 2019, 2020, 2020, 2020),
  qtr = c(1, 2, 3, 2, 3, 4), 
  return = c(1, 2, 3, NA, 2, 3)
)

stocks

```

- Where is explicit missing value?

- Does `stocks` have implicit missing values?

```{r}
# implicit missing values become explicit 
stocks %>%
  pivot_wider(names_from = year, 
              values_from = return)
```

**Practice 2**

- This exercise comes from [`pivot` function vigenette](https://tidyr.tidyverse.org/articles/pivot.html).

- Could you make `station` a series of dummy variables using `pivot_wider()`?

```{r}
fish_encounters
```

1. Which pivot you should use?

2. Are there explicit missing values? 

3. How could you make turn these NAs into 0s? Check `values_fill` argument in the `pivot_wider()` function. 

## Separate

![Messy Data Case 2 (Source: R for Data Science)](https://garrettgman.github.io/images/tidy-6.png)

```{r}

# Toy example
df <- data.frame(x = c(NA, "Dad.apple", "Mom.orange", "Daughter.banana"))

df

```

```{r}

# Separate
df %>%
  separate(x, into = c("Name", "Preferred_fruit"))

# Don't need the first variable

df %>%
  separate(x, into = c(NA, "Preferred_fruit"))
```

**Practice**

```{r}
table3
```

- Note `sep` argument. You can specify how to separate joined values.

```{r}
table3 %>%
  separate(rate,
           into = c("cases", "population"),
           sep = "/")
```

- Note `convert` argument. You can specify whether automatically convert the new values or not.

```{r}
table3 %>%
  separate(rate,
           into = c("cases", "population"),
           sep = "/",
           convert = TRUE) # cases and population become integers
```

## Unite

`pivot_longer()` <-> `pivot_wider()`

`separate()` <-> `unite()`

```{r}

# Create a toy example
df <- data.frame(
  name = c("Jae", "Sun", "Jane", NA),
  birthmonth = c("April", "April", "June", NA))

# Include missing values
df %>% unite("contact",
             c("name", "birthmonth"))

# Do not include missing values
df %>% unite("contact",
             c("name", "birthmonth"),
             na.rm = TRUE)

```

**Practice**

This example was inspired by a blog post titled ["Compute Correlations Using the Tidyverse"](http://albertotb.com/Compute-correlations-using-the-tidyverse/) written by Alberto Torres Barrán.

- Toy data

```{r}

# For reproducibility
set.seed(1234)

# Toy data
patients <- tibble(date = lubridate::ymd(rep(c(20020101, 20191101, 20200301), each = 3)),
                virus = rep(
                  c("sars", "mers", "covid"), # Vector
                  each = 3), # Each element of the vector will be repeated by the number defined by each argument
                affected = sample(
                  1:20, # Data
                  size = 9, # The number of rows to select
                  replace = TRUE)) # Replacement

```


**Additional tips**

Two ways to create a tibble object.

```{r}
# 1. By columns:

toy1 <- tibble(x = 1:3, y = c("CA", "NY", "TX"))

# 2. By rows:

toy2 <- tribble(~x, ~y,
                      1,  "CA",
                      2,  "NY",
                      3,  "TX",)

# Check
toy1 == toy2

```

- Correlation-matrix

The following code is adapted from [this stackoverflow post](https://stackoverflow.com/questions/58837773/pivot-wider-issue-values-in-values-from-are-not-uniquely-identified-output-w).

**Additional tips**

`tibble' package has some great tools to work with row names (for more information, see [this package vigentte](https://tibble.tidyverse.org/reference/rownames.html)).

1. Detect row names: `has_rownames(data)`, `has_rownames(data)`

2. Remove row names: `remove_rownmaes(data)`

3. Convert row names to column: `row_names_to_column(data, var = "new column name") %>% as_tibble()`

4. Add rowid as a column: `rowid_to_column(data)`

```{r}

cor_matrix <-
  patients %>%
    group_by(virus) %>%
    mutate(row = row_number()) %>%  # Without this identifier you will get an error because of the duplicate rows
    pivot_wider(names_from = virus,
                values_from = affected,
                values_fill = list(affected = 0)) %>%
    select(-c("row", "date")) %>%
    cor() # Calculate correlations

cor_matrix
```

- Could you turn the correlation matrix into a tidy dataframe?

```{r}

cor_matrix %>%
  as.data.frame() %>% # Don't use tibble()
  rownames_to_column(var = "virus1") %>%
  pivot_longer(cols = -virus1,
               names_to = "virus2",
               values_to = "corr")

```

# Represent Data

## Arrange

- Order rows

```{r}

dplyr::arrange(mtcars, mpg) # Low to High (default)

dplyr::arrange(mtcars, desc(mpg)) # High to Row

```

## Rename

- Rename columns

```{r}

df <- tibble(y = c(2011, 2012, 2013))

df

df %>% rename(Year = # OLD name
                y) # NEW name

```
